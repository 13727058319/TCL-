<!DOCTYPE html>
<html lang="zh-CN">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>ğŸŠTCLæŠ½å¥–å¥–</title>  
    <script src="https://cdn.tailwindcss.com"></script>  
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">  
    <style>  
        /* --- CSS å˜é‡ä¸ä¸»é¢˜å®šä¹‰ --- */
        :root {  
            /* é»˜è®¤ï¼šå–œåº†çº¢ */
            --bg-gradient: linear-gradient(135deg, #c31432 0%, #dc2430 50%, #f37335 100%);  
            --sidebar-bg: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);  
            --panel-bg: rgba(139, 0, 0, 0.4);  
            --text-primary: #ffd700;       /* é‡‘è‰²æ ‡é¢˜ */
            --text-secondary: #ffecb3;     /* æµ…é‡‘å‰¯æ ‡é¢˜ */
            --accent-color: #ffd700;       /* å¼ºè°ƒè‰²/è¾¹æ¡† */
            --btn-bg: linear-gradient(to right, #eab308, #ca8a04);  
            --shadow-color: rgba(255, 215, 0, 0.5);  
            --glass-border: rgba(255, 215, 0, 0.3);  
            --font-family: 'Microsoft YaHei', sans-serif;  
            --danmaku-bg: rgba(255, 215, 0, 0.2);  
            --danmaku-border: rgba(255, 215, 0, 0.4);  
        }

        /* ä¸»é¢˜ï¼šç§‘æŠ€è“ */
        body.theme-tech {  
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);  
            --sidebar-bg: rgba(10, 25, 47, 0.95);  
            --panel-bg: rgba(0, 255, 255, 0.1);  
            --text-primary: #00f2ff;  
            --text-secondary: #a5f3fc;  
            --accent-color: #00f2ff;  
            --btn-bg: linear-gradient(to right, #06b6d4, #0891b2);  
            --shadow-color: rgba(0, 242, 255, 0.6);  
            --glass-border: rgba(0, 242, 255, 0.3);  
            --font-family: 'Segoe UI', 'Roboto', sans-serif;  
            --danmaku-bg: rgba(0, 242, 255, 0.15);  
            --danmaku-border: rgba(0, 242, 255, 0.3);  
        }

        /* ä¸»é¢˜ï¼šç®€çº¦ç™½ */
        body.theme-white {  
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);  
            --sidebar-bg: rgba(255, 255, 255, 0.95);  
            --panel-bg: rgba(255, 255, 255, 0.6);  
            --text-primary: #333333;  
            --text-secondary: #555555;  
            --accent-color: #4a90e2;  
            --btn-bg: linear-gradient(to right, #4a90e2, #357abd);  
            --shadow-color: rgba(0, 0, 0, 0.2);  
            --glass-border: rgba(0, 0, 0, 0.1);  
            --font-family: 'Helvetica Neue', sans-serif;  
            --danmaku-bg: rgba(74, 144, 226, 0.1);  
            --danmaku-border: rgba(74, 144, 226, 0.3);  
        }

        /* ä¸»é¢˜ï¼šæš—é»‘é‡‘ */
        body.theme-dark {  
            --bg-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);  
            --sidebar-bg: #111111;  
            --panel-bg: rgba(30, 30, 30, 0.8);  
            --text-primary: #d4af37;  
            --text-secondary: #c0c0c0;  
            --accent-color: #d4af37;  
            --btn-bg: linear-gradient(to right, #d4af37, #aa8c2c);  
            --shadow-color: rgba(212, 175, 55, 0.4);  
            --glass-border: rgba(212, 175, 55, 0.3);  
            --font-family: 'Times New Roman', serif;  
            --danmaku-bg: rgba(212, 175, 55, 0.15);  
            --danmaku-border: rgba(212, 175, 55, 0.3);  
        }

        /* ä¸»é¢˜ï¼šæµªæ¼«ç²‰ */
        body.theme-pink {  
            --bg-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);  
            --sidebar-bg: rgba(255, 255, 255, 0.8);  
            --panel-bg: rgba(255, 255, 255, 0.5);  
            --text-primary: #ff6b6b;  
            --text-secondary: #ff8e8e;  
            --accent-color: #ff6b6b;  
            --btn-bg: linear-gradient(to right, #ff758c, #ff7eb3);  
            --shadow-color: rgba(255, 107, 107, 0.4);  
            --glass-border: rgba(255, 255, 255, 0.6);  
            --font-family: 'Microsoft YaHei', sans-serif;  
            --danmaku-bg: rgba(255, 107, 107, 0.1);  
            --danmaku-border: rgba(255, 107, 107, 0.3);  
        }

        /* è‡ªå®šä¹‰èƒŒæ™¯è‰² */
        body.theme-custom {  
            --bg-gradient: var(--custom-bg-color);  
        }

        /* --- åŸºç¡€æ ·å¼é‡ç½® --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }  
        
        body {  
            font-family: var(--font-family);  
            background: var(--bg-gradient);  
            color: var(--text-primary);  
            overflow: hidden;  
            transition: background 0.5s ease;  
        }

        /* åŠ¨æ€ç±»ï¼šåº”ç”¨CSSå˜é‡ */
        .text-theme-primary { color: var(--text-primary) !important; text-shadow: 0 2px 4px var(--shadow-color); }  
        .text-theme-secondary { color: var(--text-secondary) !important; }  
        .bg-theme-sidebar { background: var(--sidebar-bg) !important; }  
        .border-theme { border-color: var(--accent-color) !important; }  
        .shadow-theme { text-shadow: 0 0 10px var(--shadow-color); }  
        
        /* ä¾§è¾¹æ è¿‡æ¸¡ */
        .sidebar-transition {  
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s ease;  
        }
        
        .sidebar-left.hidden-sidebar { transform: translateX(-100%); }  
        .sidebar-right.hidden-sidebar { transform: translateX(100%); }  
        .stats-panel.hidden-stats { transform: translateY(100%); }  

        /* æ»šåŠ¨åŠ¨ç”» */
        @keyframes roll {  
            0%, 100% { transform: translateY(-5px); }  
            50% { transform: translateY(5px); }  
        }
        .rolling { animation: roll 0.1s infinite; }  

        /* ä¸­å¥–å¡ç‰‡ */
        @keyframes winnerPop {  
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }  
            50% { transform: scale(1.05) rotate(2deg); }  
            100% { transform: scale(1) rotate(0deg); opacity: 1; }  
        }
        
        .winner-card {  
            animation: winnerPop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);  
            background: var(--panel-bg);  
            backdrop-filter: blur(10px);  
            border: 1px solid var(--glass-border);  
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);  
        }

        /* å…‰è£æ¦œ */
        .glass-panel {  
            background: var(--panel-bg);  
            backdrop-filter: blur(15px);  
            border-left: 2px solid var(--accent-color);  
            box-shadow: -5px 0 25px rgba(0,0,0,0.3);  
        }

        /* æŠ˜å å†…å®¹ */
        .round-content {  
            display: grid;  
            grid-template-rows: 0fr;  
            transition: grid-template-rows 0.3s ease-out;  
        }
        .round-content.expanded { grid-template-rows: 1fr; }  
        .round-inner { overflow: hidden; }  
        .collapse-icon { transition: transform 0.3s ease; }  
        .collapse-icon.collapsed { transform: rotate(-90deg); }  

        /* çƒŸèŠ±ä¸é‡‘å¸ */
        @keyframes firework {  
            0% { transform: translate(0, 0) scale(1); opacity: 1; }  
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }  
        }
        .firework {  
            position: fixed;  
            width: 6px;  
            height: 6px;  
            border-radius: 50%;  
            animation: firework 1s ease-out forwards;  
            pointer-events: none;  
            z-index: 9999;  
        }

        @keyframes coinFall {  
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }  
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0.3; }  
        }
        .coin {  
            position: fixed;  
            top: -50px;  
            font-size: 3rem;  
            animation: coinFall linear forwards;  
            pointer-events: none;  
            z-index: 1;  
        }

        /* æŒ‰é’®ä¸è¾“å…¥æ¡† */
        @keyframes pulse {  
            0%, 100% { box-shadow: 0 0 0 0 var(--shadow-color); }  
            50% { box-shadow: 0 0 0 15px rgba(0,0,0,0); }  
        }
        .btn-pulse { animation: pulse 2s infinite; }  

        input[type="text"], input[type="number"], input[type="color"], select {  
            background: rgba(255, 255, 255, 0.1) !important;  
            border: 1px solid var(--accent-color) !important;  
            color: var(--text-primary) !important;  
            transition: all 0.3s;  
        }
        input:focus, select:focus {  
            outline: none;  
            box-shadow: 0 0 10px var(--shadow-color) !important;  
            background: rgba(255, 255, 255, 0.2) !important;  
        }

        /* é¢œè‰²é€‰æ‹©å™¨ç‰¹æ®Šæ ·å¼ */
        input[type="color"] {  
            height: 42px;  
            cursor: pointer;  
            border-radius: 0.75rem;  
        }

        /* å¿…å¡«æ ‡è®° */
        .required-field::after {  
            content: '*';  
            color: #ff4444;  
            margin-left: 4px;  
            font-weight: bold;  
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }  
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }  
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 4px; }  

        /* ä¸»æŒ‰é’® */
        .btn-main {  
            background: var(--btn-bg);  
            color: white;  
            position: relative;  
            overflow: hidden;  
            transition: transform 0.2s;  
        }
        .btn-main:hover { transform: scale(1.05); filter: brightness(1.1); }  
        
        .theme-btn {  
            width: 1.8rem; height: 1.8rem; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);  
        }
        .theme-btn.active { transform: scale(1.2); border-color: var(--text-primary); }  

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {  
            background: var(--sidebar-bg);  
            border-top: 2px solid var(--accent-color);  
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);  
            position: relative;  
        }

        /* æµ®åŠ¨æŒ‰é’® */
        .float-btn {  
            position: fixed;  
            z-index: 100;  
            background: var(--sidebar-bg);  
            border: 1px solid var(--accent-color);  
            color: var(--text-primary);  
            padding: 0.5rem;  
            border-radius: 0.5rem;  
            cursor: pointer;  
            transition: all 0.3s;  
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);  
        }

        /* äººå‘˜æ ‡ç­¾æ ·å¼ */
        .person-tag {  
            display: inline-flex;  
            align-items: center;  
            background: var(--panel-bg);  
            border: 1px solid var(--glass-border);  
            border-radius: 0.5rem;  
            padding: 0.25rem 0.5rem;  
            margin: 0.2rem;  
            font-size: 0.75rem;  
            color: var(--text-primary);  
            transition: all 0.2s;  
            cursor: pointer;  
        }
        
        .person-tag:hover {  
            transform: scale(1.05);  
            background: var(--accent-color);  
            color: white;  
        }

        .pool-container {  
            background: var(--panel-bg);  
            backdrop-filter: blur(10px);  
            border: 1px solid var(--glass-border);  
            border-radius: 0.5rem;  
            height: 100%;  
            display: flex;  
            flex-direction: column;  
        }

        .pool-header {  
            padding: 0.75rem;  
            border-bottom: 1px solid var(--glass-border);  
            display: flex;  
            justify-content: space-between;  
            align-items: center;  
            flex-shrink: 0;  
        }

        .pool-content {  
            flex: 1;  
            overflow-y: auto;  
            padding: 0.5rem;  
        }

        /* æ‹–æ‹½è°ƒæ•´é«˜åº¦çš„æ‰‹æŸ„ */
        .resize-handle {  
            position: absolute;  
            top: 0;  
            left: 0;  
            right: 0;  
            height: 8px;  
            cursor: ns-resize;  
            z-index: 100;  
            display: flex;  
            align-items: center;  
            justify-content: center;  
            background: transparent;  
            transition: background 0.2s;  
        }

        .resize-handle:hover {  
            background: var(--accent-color);  
        }

        .resize-handle::before {  
            content: '';  
            width: 60px;  
            height: 4px;  
            background: var(--accent-color);  
            border-radius: 2px;  
            opacity: 0.5;  
            transition: opacity 0.2s;  
        }

        .resize-handle:hover::before {  
            opacity: 1;  
        }

        .resize-handle-icon {  
            position: absolute;  
            font-size: 10px;  
            color: var(--text-primary);  
            opacity: 0;  
            transition: opacity 0.2s;  
        }

        .resize-handle:hover .resize-handle-icon {  
            opacity: 1;  
        }

        /* æ‹–æ‹½æ—¶çš„è§†è§‰åé¦ˆ */
        .resizing {  
            user-select: none;  
        }

        .resizing .stats-panel {  
            transition: none !important;  
        }

        /* èµåŠ©å®˜æ ‡ç­¾æ ·å¼ - æ”¾å¤§ç‰ˆæœ¬ */
        .sponsor-badge {  
            display: inline-block;  
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);  
            color: white;  
            padding: 0.5rem 1.5rem;  
            border-radius: 2rem;  
            font-size: 1.25rem;  
            font-weight: bold;  
            margin-top: 0.75rem;  
            margin-bottom: 0.5rem;  
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);  
            animation: sponsorGlow 2s ease-in-out infinite;  
            letter-spacing: 1px;  
        }

        @keyframes sponsorGlow {  
            0%, 100% { 
                box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);  
                transform: scale(1);  
            }
            50% { 
                box-shadow: 0 6px 24px rgba(102, 126, 234, 0.8);  
                transform: scale(1.02);  
            }
        }

        /* æ–‡æœ¬æˆªæ–­ */
        .line-clamp-1 {  
            display: -webkit-box;  
            -webkit-line-clamp: 1;  
            -webkit-box-orient: vertical;  
            overflow: hidden;  
        }
        
        .line-clamp-2 {  
            display: -webkit-box;  
            -webkit-line-clamp: 2;  
            -webkit-box-orient: vertical;  
            overflow: hidden;  
        }
    </style>
</head>  
<body class="h-screen flex flex-col">  

    <!-- ä¸»ä½“å¸ƒå±€ -->
    <div class="flex-1 flex overflow-hidden relative">  
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div id="left-sidebar" class="sidebar-left sidebar-transition bg-theme-sidebar flex flex-col overflow-y-auto absolute left-0 top-0 h-full z-50 w-72 lg:w-80">  
            <div class="p-4 lg:p-6 space-y-4 lg:space-y-6">  
                <!-- æ ‡é¢˜ -->
                <div class="text-center border-b border-theme pb-3 lg:pb-4">  
                    <h2 class="text-2xl lg:text-3xl font-black text-theme-primary mb-1">ğŸ‰ æ§åˆ¶å°</h2>  
                    <div class="h-1 w-16 bg-theme mx-auto mt-2" style="background: var(--accent-color)"></div>  
                </div>  

                <!-- ä¸»é¢˜åˆ‡æ¢ -->
                <div class="space-y-2">  
                    <label class="block font-bold text-theme-secondary text-xs lg:text-sm">ğŸ¨ ä¸»é¢˜é£æ ¼</label>  
                    <div class="flex gap-2 lg:gap-3 justify-center bg-black/20 p-2 lg:p-3 rounded-xl">  
                        <div class="theme-btn active" style="background: #c31432;" onclick="setTheme('default')" title="å–œåº†çº¢"></div>  
                        <div class="theme-btn" style="background: #0f2027;" onclick="setTheme('theme-tech')" title="ç§‘æŠ€è“"></div>  
                        <div class="theme-btn" style="background: #f5f7fa;" onclick="setTheme('theme-white')" title="ç®€çº¦ç™½"></div>  
                        <div class="theme-btn" style="background: #000000;" onclick="setTheme('theme-dark')" title="æš—é»‘é‡‘"></div>  
                        <div class="theme-btn" style="background: #ff9a9e;" onclick="setTheme('theme-pink')" title="æµªæ¼«ç²‰"></div>  
                    </div>  
                </div>  

                <!-- è‡ªå®šä¹‰èƒŒæ™¯è‰² -->
                <div class="space-y-2">  
                    <label class="block font-bold text-theme-secondary text-xs lg:text-sm">ğŸ–Œï¸ è‡ªå®šä¹‰èƒŒæ™¯</label>  
                    <div class="flex gap-2">  
                        <input type="color" id="custom-bg-color" value="#c31432"   
                               class="flex-1 cursor-pointer"  
                               onchange="applyCustomBackground(this.value)">  
                        <button onclick="resetCustomBackground()"   
                                class="bg-gray-600/80 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-xs transition-all">  
                            é‡ç½®  
                        </button>  
                    </div>  
                </div>  

                <!-- åå•å¯¼å…¥ -->
                <div class="space-y-2 lg:space-y-3">  
                    <label class="block font-bold text-theme-primary text-lg lg:text-xl">ğŸ“‹ å¯¼å…¥åå•</label>  
                    <div class="bg-black/10 border border-theme rounded-lg p-2 lg:p-3 text-xs text-theme-secondary">  
                        <p>ğŸ’¡ æ ¼å¼ï¼šéƒ¨é—¨ï¼šå§“å (æ¯è¡Œä¸€äºº)</p>
                    </div>  
                    <label class="btn-main cursor-pointer block text-center py-2 lg:py-3 rounded-xl shadow-lg font-bold text-sm lg:text-base">  
                        <i class="fas fa-upload mr-2"></i> é€‰æ‹©TXTæ–‡ä»¶  
                        <input type="file" id="file-input" accept=".txt" class="hidden" onchange="loadNames(this)">  
                    </label>  
                    <div class="flex justify-between items-center px-1">  
                        <span id="file-status" class="text-gray-400 text-xs">æœªåŠ è½½</span>  
                        <span class="text-theme-secondary text-sm">æ€»æ•°: <strong id="total-people" class="text-theme-primary text-lg">0</strong> äºº</span>  
                    </div>  
                </div>  

                <div class="h-px bg-theme opacity-30" style="background: var(--accent-color)"></div>  

                <!-- å¥–é¡¹é…ç½® -->
                <div class="space-y-3 lg:space-y-4">  
                    <label class="block font-bold text-theme-primary text-lg lg:text-xl">ğŸ å¥–å“è®¾ç½®</label>  
                    
                    <!-- å¥–å“åç§° - å¿…å¡« -->
                    <div class="relative">  
                        <label class="block text-theme-secondary text-xs mb-2 required-field">å¥–å“åç§°</label>  
                        <input type="text" id="prize-name" placeholder="ğŸ† è¯·è¾“å…¥å¥–é¡¹åç§°" required  
                               class="w-full rounded-xl font-bold text-center py-2 lg:py-3 text-base lg:text-lg">  
                    </div>  
                    
                    <!-- æ¢¦æƒ³èµåŠ©å®˜ - å¿…å¡« -->
                    <div class="relative">  
                        <label class="block text-theme-secondary text-xs mb-2 required-field">æ¢¦æƒ³èµåŠ©å®˜</label>  
                        <div class="relative">  
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-purple-400">  
                                <i class="fas fa-hand-holding-heart"></i>  
                            </div>  
                            <input type="text" id="sponsor-name" placeholder="âœ¨ è¯·è¾“å…¥èµåŠ©å®˜å§“å" required  
                                   class="w-full rounded-xl font-bold text-center py-2 lg:py-3 text-sm lg:text-base pl-10">  
                        </div>  
                    </div>  
                    
                    <div class="flex gap-2">  
                        <div class="flex-1">  
                            <label class="block text-theme-secondary text-xs mb-1">æŠ½å–äººæ•°</label>  
                            <input type="number" id="draw-count" value="1" min="1"   
                                   class="w-full rounded-xl font-bold text-center py-2 lg:py-3 text-lg lg:text-xl">  
                        </div>  
                        <div class="flex items-end">  
                            <label class="flex items-center bg-black/10 rounded-xl cursor-pointer hover:bg-black/20 transition border border-theme px-2 py-2 lg:px-3 lg:py-3 h-[46px] lg:h-[54px]">  
                                <input type="checkbox" id="allow-repeat" class="mr-2 accent-current w-4 h-4">  
                                <span class="text-theme-secondary font-bold text-xs lg:text-sm">å¯é‡å¤</span>  
                            </label>  
                        </div>  
                    </div>  
                </div>  

                <!-- æ’é™¤åå• -->
                <details class="group bg-black/10 rounded-xl border border-theme">  
                    <summary class="flex justify-between items-center cursor-pointer list-none p-2 lg:p-3 text-theme-secondary font-bold text-sm">  
                        <span>ğŸš« æ’é™¤è®¾ç½®</span>
                        <span class="transition group-open:rotate-180"><i class="fas fa-chevron-down"></i></span>  
                    </summary>  
                    <div class="p-2 lg:p-3 pt-0 space-y-2">  
                         <label class="cursor-pointer bg-red-900/50 hover:bg-red-800/50 border border-red-500/50 text-red-200 text-xs py-2 rounded-lg text-center block transition-all">  
                            ä¸Šä¼ æ’é™¤åå•
                            <input type="file" id="exclude-input" accept=".txt" class="hidden" onchange="loadExclude(this)">  
                        </label>  
                        <div id="exclude-status" class="text-xs text-gray-400 text-center">æ— æ’é™¤</div>  
                        <label class="flex items-center justify-center cursor-pointer">  
                            <input type="checkbox" id="enable-exclude" class="mr-2" onchange="updatePoolDisplay();">  
                            <span class="text-xs text-theme-secondary">å¯ç”¨æ’é™¤åå•</span>  
                        </label>  
                    </div>  
                </details>  

                <!-- å¯¼å‡ºæŒ‰é’® -->
                <button onclick="exportResults()"   
                        class="w-full bg-green-600/80 hover:bg-green-600 text-white font-bold rounded-xl transition-all shadow-lg py-2 lg:py-3 mt-2 text-sm lg:text-base">  
                    <i class="fas fa-download mr-2"></i> å¯¼å‡ºç»“æœ  
                </button>  
            </div>  
        </div>  

        <!-- ä¾§è¾¹æ æ”¶èµ·/å±•å¼€æŒ‰é’® -->
        <button id="left-close-btn" onclick="toggleLeftSidebar()" class="sidebar-close-btn fixed z-[60] text-white bg-red-600 hover:bg-red-700 px-2 py-1 rounded shadow-lg transition-all text-xs font-bold top-4 left-[16.5rem] lg:left-[18.5rem]">  
            <i class="fas fa-chevron-left"></i>  
        </button>  
        <button id="show-left-btn" onclick="toggleLeftSidebar()" class="float-btn hidden top-1/2 left-2 -translate-y-1/2">  
            <i class="fas fa-chevron-right"></i>  
        </button>  

        <!-- ä¸»èˆå° -->
        <div class="flex-1 flex flex-col p-2 lg:p-4 overflow-hidden relative min-w-0">  
            <!-- æ¸…ç©ºæŒ‰é’® -->
            <button id="btn-clear" onclick="clearScreen()"   
                    class="hidden absolute top-4 right-4 z-40 bg-gray-600/50 hover:bg-gray-600 text-white px-3 py-1 lg:px-4 lg:py-2 rounded-full text-xs lg:text-sm backdrop-blur-sm border border-white/20 transition-all">  
                <i class="fas fa-eraser mr-1"></i> æ¸…ç©º  
            </button>  

            <!-- æ ‡é¢˜åŒºåŸŸ -->
            <div class="text-center mb-2 lg:mb-6 mt-2 flex flex-col justify-center flex-shrink-0" style="min-height: 100px;">  
                <h1 id="display-prize" class="text-3xl md:text-5xl lg:text-6xl font-black text-theme-primary mb-1 drop-shadow-2xl transition-all leading-tight">  
                    ğŸ å‡†å¤‡æŠ½å¥–
                </h1>  
                <!-- èµåŠ©å®˜æ˜¾ç¤º - æ”¾å¤§ç‰ˆæœ¬ -->
                <div id="display-sponsor" class="hidden">  
                    <span class="sponsor-badge">  
                        <i class="fas fa-hand-holding-heart mr-2"></i>  
                        æ¢¦æƒ³èµåŠ©å®˜ï¼š<span id="sponsor-text"></span>  
                    </span>  
                </div>  
                <p class="text-base md:text-xl lg:text-2xl text-theme-secondary mt-2">  
                    æœ¬è½®æŠ½å– <span id="display-count" class="font-black text-theme-primary text-xl md:text-2xl">1</span> äºº  
                </p>  
            </div>  

            <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
            <div class="flex justify-center gap-4 mb-4 lg:mb-8 z-30 flex-shrink-0">  
                <button id="btn-start" onclick="start()"   
                        class="btn-main btn-pulse text-xl md:text-2xl lg:text-3xl font-black py-2 px-8 md:py-3 md:px-10 rounded-full shadow-2xl border-4 border-white/20">  
                    <i class="fas fa-play mr-2"></i> å¼€å§‹  
                </button>  
                <button id="btn-stop" onclick="stop()"   
                        class="hidden btn-main bg-red-600 text-xl md:text-2xl lg:text-3xl font-black py-2 px-8 md:py-3 md:px-10 rounded-full shadow-2xl border-4 border-white/20">  
                    <i class="fas fa-stop mr-2"></i> åœæ­¢  
                </button>  
            </div>  

            <!-- æ»šåŠ¨/ç»“æœå±•ç¤ºåŒº -->
            <div class="flex-1 flex items-center justify-center relative w-full overflow-hidden min-h-0">  
                <!-- æ»šåŠ¨åå­— -->
                <div id="rolling-area" class="text-center w-full px-4">  
                    <div id="rolling-name" class="font-black text-theme-primary rolling break-words"   
                         style="font-size: clamp(2.5rem, 5vw, 6rem); line-height: 1.2;">  
                        å‡†å¤‡å°±ç»ª
                    </div>  
                    <div id="rolling-dept" class="text-xl md:text-2xl text-theme-secondary mt-2 opacity-80"></div>  
                </div>  

                <!-- ä¸­å¥–ç»“æœ - å±…ä¸­ç½‘æ ¼å¸ƒå±€ -->
                <div id="result-area" class="hidden absolute inset-0 flex items-center justify-center p-4 overflow-hidden">  
                    <div id="result-grid" class="w-full h-full flex items-center justify-center">  
                        <!-- JS åŠ¨æ€æ’å…¥å¡ç‰‡ -->
                    </div>  
                </div>  
            </div>  
        </div>  

        <!-- å³ä¾§é”¦é²¤å†Œ -->
        <div id="right-sidebar" class="sidebar-right sidebar-transition glass-panel flex flex-col absolute right-0 top-0 h-full z-50 w-72 lg:w-80">  
            <div class="bg-black/20 text-center border-b border-theme sticky top-0 z-10 p-3 lg:p-4">  
                <h3 class="text-theme-primary text-xl lg:text-2xl font-black">  
                    <i class="fas fa-fish mr-2"></i> é”¦é²¤å†Œ  
                </h3>  
            </div>  
            
            <div id="history-list" class="p-3 lg:p-4 space-y-3 overflow-y-auto flex-1">  
                <div class="text-center text-theme-secondary mt-10 lg:mt-20 text-base lg:text-lg opacity-50">æš‚æ— ä¸­å¥–è®°å½•</div>  
            </div>  
        </div>  

        <!-- å³ä¾§æ”¶èµ·æŒ‰é’® -->
        <button id="right-close-btn" onclick="toggleRightSidebar()" class="sidebar-close-btn fixed z-[60] text-white bg-red-600 hover:bg-red-700 px-2 py-1 rounded shadow-lg transition-all text-xs font-bold top-4 right-[17.5rem] lg:right-[19.5rem]">  
            æ”¶èµ· <i class="fas fa-chevron-right"></i>  
        </button>  
        <button id="show-right-btn" onclick="toggleRightSidebar()" class="float-btn hidden top-1/2 right-2 -translate-y-1/2">  
            <i class="fas fa-chevron-left"></i>  
        </button>  
    </div>  

    <!-- åº•éƒ¨å¥–æ± é¢æ¿ï¼ˆå¯æ‹–æ‹½è°ƒæ•´é«˜åº¦ï¼‰ -->
    <div id="stats-panel" class="stats-panel flex-shrink-0 relative z-40" style="height: 300px;">  
        <!-- æ‹–æ‹½æ‰‹æŸ„ -->
        <div class="resize-handle" id="resize-handle">  
            <i class="fas fa-grip-lines resize-handle-icon"></i>  
        </div>  
        
        <div class="px-3 py-2 lg:px-4 lg:py-3 h-full flex gap-3 pt-4">  
            <!-- å¥–æ± äººå‘˜ -->
            <div class="flex-1 pool-container">  
                <div class="pool-header">  
                    <div class="flex items-center gap-2">  
                        <i class="fas fa-users text-theme-primary"></i>  
                        <span class="font-bold text-theme-primary text-sm">å¥–æ± äººå‘˜</span>  
                    </div>  
                    <span class="text-theme-secondary text-xs">  
                        å…± <strong id="pool-count" class="text-theme-primary text-base">0</strong> äºº  
                    </span>  
                </div>  
                <div id="pool-list" class="pool-content">  
                    <div class="text-center text-theme-secondary text-xs opacity-50 mt-4">æš‚æ— æ•°æ®</div>  
                </div>  
            </div>  

            <!-- å·²ä¸­å¥–äººå‘˜ -->
            <div class="flex-1 pool-container">  
                <div class="pool-header">  
                    <div class="flex items-center gap-2">  
                        <i class="fas fa-trophy text-theme-primary"></i>  
                        <span class="font-bold text-theme-primary text-sm">å·²ä¸­å¥–äººå‘˜</span>  
                    </div>  
                    <div class="flex items-center gap-2">  
                        <span class="text-theme-secondary text-xs">  
                            å…± <strong id="winner-count" class="text-theme-primary text-base">0</strong> äºº  
                        </span>  
                        <button onclick="resetAllWinners()" class="text-xs bg-orange-600/80 hover:bg-orange-600 text-white px-2 py-1 rounded transition-all" title="å…¨éƒ¨å›æ± ">  
                            <i class="fas fa-redo text-xs"></i>  
                        </button>  
                    </div>  
                </div>  
                <div id="winner-list" class="pool-content">  
                    <div class="text-center text-theme-secondary text-xs opacity-50 mt-4">æš‚æ— ä¸­å¥–</div>  
                </div>  
            </div>  
        </div>  
    </div>  

    <script>  
        // --- æ ¸å¿ƒé€»è¾‘ ---
        
        let allPeople = [];  
        let excludePeople = [];  
        let roundHistory = [];   
        let currentRound = 0;  
        let isRolling = false;  
        let timer = null;  
        let leftSidebarVisible = true;  
        let rightSidebarVisible = true;  
        let statsPanelVisible = true;  
        let currentTheme = 'default';

        const $ = (id) => document.getElementById(id);  

        // --- è‡ªå®šä¹‰èƒŒæ™¯è‰²åŠŸèƒ½ ---
        function applyCustomBackground(color) {  
            document.documentElement.style.setProperty('--custom-bg-color', `linear-gradient(135deg, ${color} 0%, ${adjustBrightness(color, -20)} 50%, ${adjustBrightness(color, 20)} 100%)`);  
            document.body.className = "h-screen flex flex-col theme-custom";  
            currentTheme = 'theme-custom';
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));  
        }

        function resetCustomBackground() {  
            setTheme('default');  
            $('custom-bg-color').value = '#c31432';  
        }

        // è¾…åŠ©å‡½æ•°ï¼šè°ƒæ•´é¢œè‰²äº®åº¦
        function adjustBrightness(color, percent) {  
            const num = parseInt(color.replace("#",""), 16);  
            const amt = Math.round(2.55 * percent);  
            const R = (num >> 16) + amt;  
            const G = (num >> 8 & 0x00FF) + amt;  
            const B = (num & 0x0000FF) + amt;  
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +   
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))  
                .toString(16).slice(1);  
        }

        // --- æ‹–æ‹½è°ƒæ•´é«˜åº¦åŠŸèƒ½ ---
        let isResizing = false;  
        let startY = 0;  
        let startHeight = 0;  
        const minHeight = 150;  
        const maxHeight = window.innerHeight * 0.6;  

        const resizeHandle = $('resize-handle');  
        const statsPanel = $('stats-panel');  

        resizeHandle.addEventListener('mousedown', function(e) {  
            isResizing = true;  
            startY = e.clientY;  
            startHeight = statsPanel.offsetHeight;  
            document.body.classList.add('resizing');  
            e.preventDefault();  
        });

        document.addEventListener('mousemove', function(e) {  
            if (!isResizing) return;  
            
            const deltaY = startY - e.clientY;  
            const newHeight = Math.min(Math.max(startHeight + deltaY, minHeight), maxHeight);  
            statsPanel.style.height = newHeight + 'px';  
        });

        document.addEventListener('mouseup', function() {  
            if (isResizing) {  
                isResizing = false;  
                document.body.classList.remove('resizing');  
            }
        });

        resizeHandle.addEventListener('dblclick', function() {  
            statsPanel.style.height = '300px';  
        });

        function setTheme(themeName) {  
            document.body.className = "h-screen flex flex-col " + (themeName === 'default' ? '' : themeName);  
            currentTheme = themeName;
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));  
            event.currentTarget.classList.add('active');  
        }

        function parsePerson(line) {  
            line = line.trim();  
            if (!line) return null;  
            if (line.includes('ï¼š') || line.includes(':')) {  
                const separator = line.includes('ï¼š') ? 'ï¼š' : ':';  
                const parts = line.split(separator);  
                return { fullText: line, dept: parts[0].trim(), name: parts.slice(1).join(separator).trim() };  
            } else {  
                return { fullText: line, dept: '', name: line };  
            }
        }

        function toggleLeftSidebar() {  
            leftSidebarVisible = !leftSidebarVisible;  
            const sidebar = $('left-sidebar');  
            const closeBtn = $('left-close-btn');  
            const showBtn = $('show-left-btn');  
            
            if (leftSidebarVisible) {  
                sidebar.classList.remove('hidden-sidebar');  
                closeBtn.style.display = 'block';  
                showBtn.classList.add('hidden');  
            } else {  
                sidebar.classList.add('hidden-sidebar');  
                closeBtn.style.display = 'none';  
                showBtn.classList.remove('hidden');  
            }
        }

        function toggleRightSidebar() {  
            rightSidebarVisible = !rightSidebarVisible;  
            const sidebar = $('right-sidebar');  
            const closeBtn = $('right-close-btn');  
            const showBtn = $('show-right-btn');  
            
            if (rightSidebarVisible) {  
                sidebar.classList.remove('hidden-sidebar');  
                closeBtn.style.display = 'block';  
                showBtn.classList.add('hidden');  
            } else {  
                sidebar.classList.add('hidden-sidebar');  
                closeBtn.style.display = 'none';  
                showBtn.classList.remove('hidden');  
            }
        }

        function hideAllPanels() {  
            if (leftSidebarVisible) {  
                leftSidebarVisible = false;  
                $('left-sidebar').classList.add('hidden-sidebar');  
                $('left-close-btn').style.display = 'none';  
                $('show-left-btn').classList.remove('hidden');  
            }
            
            if (rightSidebarVisible) {  
                rightSidebarVisible = false;  
                $('right-sidebar').classList.add('hidden-sidebar');  
                $('right-close-btn').style.display = 'none';  
                $('show-right-btn').classList.remove('hidden');  
            }
            
            if (statsPanelVisible) {  
                statsPanelVisible = false;  
                $('stats-panel').classList.add('hidden-stats');  
            }
        }

        function showAllPanels() {  
            if (!leftSidebarVisible) {  
                leftSidebarVisible = true;  
                $('left-sidebar').classList.remove('hidden-sidebar');  
                $('left-close-btn').style.display = 'block';  
                $('show-left-btn').classList.add('hidden');  
            }
            
            if (!rightSidebarVisible) {  
                rightSidebarVisible = true;  
                $('right-sidebar').classList.remove('hidden-sidebar');  
                $('right-close-btn').style.display = 'block';  
                $('show-right-btn').classList.add('hidden');  
            }
            
            if (!statsPanelVisible) {  
                statsPanelVisible = true;  
                $('stats-panel').classList.remove('hidden-stats');  
            }
        }

        function loadNames(input) {  
            const file = input.files[0];  
            if (!file) return;  
            const reader = new FileReader();  
            reader.onload = (e) => {  
                const lines = e.target.result.split(/\r?\n/);  
                allPeople = lines.map(parsePerson).filter(p => p !== null);  
                const uniqueMap = new Map();  
                allPeople.forEach(p => uniqueMap.set(p.fullText, p));  
                allPeople = Array.from(uniqueMap.values());  
                
                $('file-status').innerHTML = `<span class="text-green-400 font-bold">âœ“ ${allPeople.length} äºº</span>`;  
                $('total-people').textContent = allPeople.length;  
                updatePoolDisplay();  
                celebrate();  
            };
            reader.readAsText(file);  
        }

        function loadExclude(input) {  
            const file = input.files[0];  
            if (!file) return;  
            const reader = new FileReader();  
            reader.onload = (e) => {  
                const lines = e.target.result.split(/\r?\n/);  
                excludePeople = lines.map(parsePerson).filter(p => p !== null);  
                const uniqueMap = new Map();  
                excludePeople.forEach(p => uniqueMap.set(p.fullText, p));  
                excludePeople = Array.from(uniqueMap.values());  
                $('exclude-status').innerHTML = `<span class="text-red-400">å·²ä¸Šä¼  ${excludePeople.length} äºº</span>`;  
                if ($('enable-exclude').checked) {  
                    updatePoolDisplay();  
                }
            };
            reader.readAsText(file);  
        }

        function getAllWinners() {  
            const allWinners = [];  
            roundHistory.forEach(round => {  
                allWinners.push(...round.winners);  
            });
            const uniqueMap = new Map();  
            allWinners.forEach(w => uniqueMap.set(w.fullText, w));  
            return Array.from(uniqueMap.values());  
        }

        function getCurrentPool() {  
            const allowRepeat = $('allow-repeat').checked;  
            const enableExclude = $('enable-exclude').checked;  
            let pool = [...allPeople];  
            
            if (enableExclude && excludePeople.length > 0) {  
                const excludeTexts = excludePeople.map(p => p.fullText);  
                pool = pool.filter(p => !excludeTexts.includes(p.fullText));  
            }
            
            if (!allowRepeat) {  
                const winnerTexts = getAllWinners().map(w => w.fullText);  
                pool = pool.filter(p => !winnerTexts.includes(p.fullText));  
            }
            
            return pool;  
        }

        function updatePoolDisplay() {  
            const pool = getCurrentPool();  
            const winners = getAllWinners();  
            
            const poolList = $('pool-list');  
            if (pool.length === 0) {  
                poolList.innerHTML = '<div class="text-center text-theme-secondary text-xs opacity-50 mt-4">å¥–æ± å·²ç©º</div>';  
            } else {  
                poolList.innerHTML = pool.map(p =>   
                    `<span class="person-tag" title="${p.dept || 'æ— éƒ¨é—¨'}">  
                        ${p.name}  
                    </span>`  
                ).join('');  
            }
            $('pool-count').textContent = pool.length;  
            
            const winnerList = $('winner-list');  
            if (winners.length === 0) {  
                winnerList.innerHTML = '<div class="text-center text-theme-secondary text-xs opacity-50 mt-4">æš‚æ— ä¸­å¥–</div>';  
            } else {  
                winnerList.innerHTML = winners.map(w =>   
                    `<span class="person-tag" title="${w.dept || 'æ— éƒ¨é—¨'} - ç‚¹å‡»å›æ± " onclick="returnToPool('${w.fullText.replace(/'/g, "\\'")}')">  
                        ${w.name} <i class="fas fa-undo ml-1 text-xs"></i>  
                    </span>`  
                ).join('');  
            }
            $('winner-count').textContent = winners.length;  
        }

        function returnToPool(fullText) {  
            if (!confirm(`ç¡®å®šå°† ${fullText.split(/ï¼š|:/)[1] || fullText} æ”¾å›å¥–æ± å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤è¯¥äººå‘˜çš„æ‰€æœ‰ä¸­å¥–è®°å½•ï¼`)) {
                return;  
            }
            
            roundHistory.forEach(round => {  
                round.winners = round.winners.filter(w => w.fullText !== fullText);  
            });
            
            roundHistory = roundHistory.filter(round => round.winners.length > 0);  
            
            updatePoolDisplay();  
            updateHistory();  
            celebrate();  
        }

        function resetAllWinners() {  
            if (getAllWinners().length === 0) {  
                alert('âŒ å½“å‰æ²¡æœ‰ä¸­å¥–äººå‘˜ï¼');
                return;  
            }
            
            if (!confirm('âš ï¸ ç¡®å®šè¦å°†æ‰€æœ‰ä¸­å¥–äººå‘˜æ”¾å›å¥–æ± å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰ä¸­å¥–è®°å½•ï¼')) {
                return;  
            }
            
            roundHistory = [];  
            currentRound = 0;  
            updatePoolDisplay();  
            updateHistory();  
            celebrate();  
        }

        // ç›‘å¬å¥–å“åç§°å’ŒèµåŠ©å®˜è¾“å…¥
        $('prize-name').addEventListener('input', (e) => {  
            $('display-prize').textContent = e.target.value || 'ğŸ å‡†å¤‡æŠ½å¥–';  
        });

        $('sponsor-name').addEventListener('input', (e) => {  
            const sponsor = e.target.value.trim();  
            if (sponsor) {  
                $('display-sponsor').classList.remove('hidden');  
                $('sponsor-text').textContent = sponsor;  
            } else {  
                $('display-sponsor').classList.add('hidden');  
            }
        });

        $('draw-count').addEventListener('input', (e) => $('display-count').textContent = e.target.value || 1);  
        $('allow-repeat').addEventListener('change', () => { updatePoolDisplay(); });  

        function start() {  
            if (allPeople.length === 0) return alert('âŒ è¯·å…ˆå¯¼å…¥äººå‘˜åå•ï¼');
            
            // éªŒè¯å¥–å“åç§°å¿…å¡«
            const prizeName = $('prize-name').value.trim();  
            if (!prizeName) {  
                alert('âŒ è¯·å¡«å†™å¥–å“åç§°ï¼');
                $('prize-name').focus();  
                return;  
            }
            
            // éªŒè¯èµåŠ©å®˜å¿…å¡«
            const sponsor = $('sponsor-name').value.trim();  
            if (!sponsor) {  
                alert('âŒ è¯·å¡«å†™æ¢¦æƒ³èµåŠ©å®˜ï¼');
                $('sponsor-name').focus();  
                return;  
            }
            
            const count = parseInt($('draw-count').value) || 1;  
            const pool = getCurrentPool();  
            
            if (pool.length < count) return alert(`âŒ å¯ç”¨äººæ•°ä¸è¶³ï¼\néœ€è¦: ${count} äºº\nå‰©ä½™: ${pool.length} äºº`);

            isRolling = true;  
            $('btn-start').classList.add('hidden');  
            $('btn-stop').classList.remove('hidden');  
            $('btn-clear').classList.add('hidden');  
            $('result-area').classList.add('hidden');  
            $('rolling-area').classList.remove('hidden');  
            
            hideAllPanels();  
            createCoins();  

            timer = setInterval(() => {  
                const person = pool[Math.floor(Math.random() * pool.length)];  
                $('rolling-name').textContent = person.name;  
                $('rolling-dept').textContent = person.dept || '';  
            }, 50);
        }

        function stop() {  
            clearInterval(timer);  
            isRolling = false;  

            const count = parseInt($('draw-count').value) || 1;  
            const prize = $('prize-name').value.trim() || 'å¹¸è¿å¥–';  
            const sponsor = $('sponsor-name').value.trim() || '';  
            let pool = getCurrentPool();  
            
            const shuffled = pool.sort(() => 0.5 - Math.random());  
            const selected = shuffled.slice(0, count);  

            const now = new Date().toLocaleString('zh-CN', { hour12: false });  
            currentRound++;  

            roundHistory.push({   
                round: currentRound,   
                prize: prize,   
                sponsor: sponsor,  
                count: count,   
                winners: selected,   
                time: now   
            });

            showWinners(selected, prize);  
            updateHistory();  
            updatePoolDisplay();  
            fireworks();  

            $('btn-stop').classList.add('hidden');  
            $('btn-start').classList.remove('hidden');  
            $('btn-clear').classList.remove('hidden');  
        }

        /**
         * â­ è¶…çº§æ™ºèƒ½è‡ªé€‚åº”å¸ƒå±€ç®—æ³• â­
         * ç‰¹ç‚¹ï¼š
         * 1. æ— è®ºå¤šå°‘äººéƒ½èƒ½å®Œç¾é€‚é…å±å¹•
         * 2. å­—ä½“å°½å¯èƒ½å¤§
         * 3. è‡ªåŠ¨è®¡ç®—æœ€ä¼˜åˆ—æ•°å’Œè¡Œæ•°
         * 4. åŠ¨æ€è°ƒæ•´å¡ç‰‡å°ºå¯¸å’Œé—´è·
         */
        function calculateOptimalLayout(count) {  
            // è·å–å¯ç”¨æ˜¾ç¤ºåŒºåŸŸï¼ˆæ‰£é™¤paddingï¼‰
            const containerWidth = window.innerWidth * 0.9;  // 90%å±å¹•å®½åº¦
            const containerHeight = window.innerHeight * 0.55; // 55%å±å¹•é«˜åº¦
            
            let cols, rows, cardWidth, cardHeight, fontSize, deptSize, gap;
            
            // ğŸ¯ ç‰¹æ®Šä¼˜åŒ–ï¼š1-9äººå›ºå®šæœ€ä½³å¸ƒå±€
            if (count === 1) {  
                return {   
                    cols: 1,   
                    cardWidth: Math.min(500, containerWidth * 0.8),   
                    cardHeight: Math.min(400, containerHeight * 0.8),  
                    fontSize: 'clamp(3rem, 8vw, 7rem)',   
                    deptSize: 'clamp(1.5rem, 3vw, 3rem)',   
                    gap: '0'   
                };  
            }
            
            if (count === 2) {  
                return {   
                    cols: 2,   
                    cardWidth: Math.min(400, containerWidth * 0.4),   
                    cardHeight: Math.min(350, containerHeight * 0.7),  
                    fontSize: 'clamp(2.5rem, 6vw, 5rem)',   
                    deptSize: 'clamp(1.2rem, 2.5vw, 2.5rem)',   
                    gap: '2rem'   
                };  
            }
            
            if (count <= 4) {  
                return {   
                    cols: 2,   
                    cardWidth: Math.min(350, containerWidth * 0.42),   
                    cardHeight: Math.min(300, containerHeight * 0.45),  
                    fontSize: 'clamp(2rem, 5vw, 4rem)',   
                    deptSize: 'clamp(1rem, 2vw, 2rem)',   
                    gap: '1.5rem'   
                };  
            }
            
            if (count <= 6) {  
                return {   
                    cols: 3,   
                    cardWidth: Math.min(280, containerWidth * 0.28),   
                    cardHeight: Math.min(250, containerHeight * 0.42),  
                    fontSize: 'clamp(1.8rem, 4vw, 3.5rem)',   
                    deptSize: 'clamp(0.9rem, 1.8vw, 1.5rem)',   
                    gap: '1.2rem'   
                };  
            }
            
            if (count <= 9) {  
                return {   
                    cols: 3,   
                    cardWidth: Math.min(250, containerWidth * 0.28),   
                    cardHeight: Math.min(220, containerHeight * 0.3),  
                    fontSize: 'clamp(1.5rem, 3.5vw, 3rem)',   
                    deptSize: 'clamp(0.8rem, 1.5vw, 1.2rem)',   
                    gap: '1rem'   
                };  
            }
            
            // ğŸš€ 10äººä»¥ä¸Šï¼šè¶…çº§æ™ºèƒ½ç®—æ³•
            // Step 1: è®¡ç®—ç†æƒ³å®½é«˜æ¯”ï¼ˆ1.2:1 é»„é‡‘æ¯”ä¾‹ï¼‰
            const idealRatio = 1.2;
            cols = Math.ceil(Math.sqrt(count * idealRatio));
            rows = Math.ceil(count / cols);
            
            // Step 2: å°è¯•ä¼˜åŒ–è¡Œåˆ—ï¼Œå‡å°‘ç©ºç™½
            const alternatives = [
                { cols: cols, rows: rows },
                { cols: cols - 1, rows: Math.ceil(count / (cols - 1)) },
                { cols: cols + 1, rows: Math.ceil(count / (cols + 1)) }
            ];
            
            let bestLayout = alternatives[0];
            let minWaste = Infinity;
            
            alternatives.forEach(layout => {
                if (layout.cols < 2) return;
                const waste = (layout.cols * layout.rows - count) / count;
                const aspectRatio = layout.cols / layout.rows;
                const ratioScore = Math.abs(aspectRatio - idealRatio);
                const totalScore = waste + ratioScore * 0.5;
                
                if (totalScore < minWaste) {
                    minWaste = totalScore;
                    bestLayout = layout;
                }
            });
            
            cols = bestLayout.cols;
            rows = bestLayout.rows;
            
            // Step 3: æ ¹æ®è¡Œåˆ—æ•°åŠ¨æ€è®¡ç®—é—´è·
            gap = Math.max(8, Math.min(20, 30 - cols * 1.5));
            
            // Step 4: è®¡ç®—å¡ç‰‡å°ºå¯¸ï¼ˆå¡«æ»¡å±å¹•ï¼‰
            cardWidth = (containerWidth - gap * (cols - 1)) / cols;
            cardHeight = (containerHeight - gap * (rows - 1)) / rows;
            
            // Step 5: é™åˆ¶å¡ç‰‡å°ºå¯¸èŒƒå›´
            const minCardSize = 80;
            const maxCardWidth = 250;
            const maxCardHeight = 220;
            
            cardWidth = Math.max(minCardSize, Math.min(maxCardWidth, cardWidth));
            cardHeight = Math.max(minCardSize, Math.min(maxCardHeight, cardHeight));
            
            // Step 6: æ ¹æ®å¡ç‰‡å¤§å°æ™ºèƒ½è°ƒæ•´å­—å·ï¼ˆä¿è¯å­—ä½“å°½å¯èƒ½å¤§ï¼‰
            const sizeScore = Math.min(cardWidth, cardHeight);
            
            if (sizeScore >= 200) {
                fontSize = 'clamp(1.8rem, 3.5vw, 3rem)';
                deptSize = 'clamp(0.9rem, 1.5vw, 1.2rem)';
            } else if (sizeScore >= 160) {
                fontSize = 'clamp(1.5rem, 3vw, 2.5rem)';
                deptSize = 'clamp(0.8rem, 1.3vw, 1rem)';
            } else if (sizeScore >= 130) {
                fontSize = 'clamp(1.3rem, 2.5vw, 2rem)';
                deptSize = 'clamp(0.75rem, 1.1vw, 0.9rem)';
            } else if (sizeScore >= 100) {
                fontSize = 'clamp(1.1rem, 2vw, 1.8rem)';
                deptSize = 'clamp(0.7rem, 1vw, 0.85rem)';
            } else {
                fontSize = 'clamp(0.9rem, 1.8vw, 1.5rem)';
                deptSize = 'clamp(0.65rem, 0.9vw, 0.75rem)';
            }
            
            return {
                cols: cols,
                cardWidth: Math.floor(cardWidth),
                cardHeight: Math.floor(cardHeight),
                fontSize: fontSize,
                deptSize: deptSize,
                gap: `${gap}px`
            };
        }

        function showWinners(people, prize) {  
            $('rolling-area').classList.add('hidden');  
            $('result-area').classList.remove('hidden');  

            const count = people.length;  
            const layout = calculateOptimalLayout(count);  
            
            // æ„å»ºå“åº”å¼Gridå¸ƒå±€
            let html = `  
                <div class="flex items-center justify-center w-full h-full overflow-auto p-4">  
                    <div class="grid place-items-center" style="
                        grid-template-columns: repeat(${layout.cols}, ${layout.cardWidth}px); 
                        gap: ${layout.gap};
                        max-height: 100%;
                    ">`;  
            
            people.forEach((person, i) => {  
                html += `  
                <div class="winner-card rounded-2xl p-3 relative overflow-hidden flex flex-col justify-center items-center text-center group hover:scale-105 transition-transform duration-300"   
                     style="
                        width: ${layout.cardWidth}px; 
                        height: ${layout.cardHeight}px; 
                        animation-delay: ${i * 0.03}s;
                     ">  
                    <div class="absolute top-1 right-2 opacity-10 group-hover:opacity-30 transition" style="font-size: ${layout.cardWidth * 0.12}px;">ğŸ‰</div>  
                    
                    <div class="font-black text-theme-primary mb-2 break-words w-full leading-tight px-2 line-clamp-2" 
                         style="font-size: ${layout.fontSize};">  
                        ${person.name}  
                    </div>  
                    
                    <div class="mb-1.5" style="
                        border-bottom: 2px solid var(--accent-color);
                        width: ${Math.min(layout.cardWidth * 0.6, 120)}px;
                    "></div>  
                    
                    ${person.dept ? `  
                        <div class="text-theme-secondary opacity-80 font-medium px-2 line-clamp-1 w-full" 
                             style="font-size: ${layout.deptSize};">  
                            ${person.dept}  
                        </div>  
                    ` : `<div class="text-theme-secondary opacity-40" style="font-size: ${layout.deptSize};">-</div>`}  
                </div>`;  
            });
            
            html += `  
                    </div>  
                </div>`;  
            
            $('result-grid').innerHTML = html;  
        }

        function clearScreen() {  
            $('result-area').classList.add('hidden');  
            $('rolling-area').classList.remove('hidden');  
            $('rolling-name').textContent = 'å‡†å¤‡å°±ç»ª';  
            $('rolling-dept').textContent = '';  
            $('btn-clear').classList.add('hidden');  
            showAllPanels();  
        }

        function updateHistory() {  
            if (roundHistory.length === 0) {  
                $('history-list').innerHTML = '<div class="text-center text-theme-secondary mt-10 lg:mt-20 text-base lg:text-lg opacity-50">æš‚æ— ä¸­å¥–è®°å½•</div>';  
                return;  
            }
            
            const reversed = [...roundHistory].reverse();  
            let html = '';  
            
            reversed.forEach((round, index) => {  
                const roundId = `round-${round.round}`;  
                const isExpanded = index === 0 ? 'expanded' : '';   
                const iconClass = index === 0 ? '' : 'collapsed';  

                html += `  
                <div class="bg-black/20 border border-theme rounded-xl shadow mb-2 overflow-hidden" style="animation: slideIn 0.3s ease forwards ${index * 0.05}s">  
                    <div class="flex items-center justify-between p-2 lg:p-3 cursor-pointer hover:bg-white/5 transition" onclick="toggleRound('${roundId}')">  
                        <div class="flex items-center gap-2 overflow-hidden">  
                            <i class="fas fa-chevron-down collapse-icon text-theme-primary text-xs ${iconClass}" id="icon-${roundId}"></i>  
                            <span class="bg-theme-sidebar border border-theme text-theme-primary px-1.5 py-0.5 rounded text-[10px] lg:text-xs whitespace-nowrap">ç¬¬${round.round}è½®</span>  
                            <span class="text-theme-secondary font-bold text-xs lg:text-sm truncate">${round.prize}</span>  
                        </div>  
                        <span class="text-theme-primary font-bold text-xs lg:text-sm">Ã—${round.count}</span>  
                    </div>  
                    
                    <div class="round-content ${isExpanded}" id="${roundId}">  
                        <div class="round-inner p-2 lg:p-3 pt-0 space-y-1 lg:space-y-2">  
                            <div class="h-px bg-theme opacity-20 mb-1"></div>  
                            ${round.sponsor ? `  
                                <div class="text-center mb-2">  
                                    <span class="text-[10px] bg-purple-600/30 text-purple-200 px-2 py-0.5 rounded-full border border-purple-400/30">  
                                        <i class="fas fa-hand-holding-heart mr-1"></i>${round.sponsor}  
                                    </span>  
                                </div>  
                            ` : ''}  
                            ${round.winners.map((person, i) => `  
                                <div class="flex justify-between items-center text-xs lg:text-sm">  
                                    <div class="flex items-center gap-2">  
                                        <span class="text-theme-secondary opacity-50 text-[10px] w-3">${i + 1}.</span>  
                                        <span class="text-theme-primary font-bold">${person.name}</span>  
                                        ${person.dept ? `<span class="text-theme-secondary opacity-60 text-[10px]">(${person.dept})</span>` : ''}  
                                    </div>  
                                    <i class="fas fa-check text-green-500 text-[10px]"></i>  
                                </div>  
                            `).join('')}  
                            <div class="text-right mt-1 text-theme-secondary opacity-40 text-[10px] scale-90 origin-right">  
                                ${round.time}  
                            </div>  
                        </div>  
                    </div>  
                </div>`;  
            });
            $('history-list').innerHTML = html;  
        }

        function toggleRound(roundId) {  
            const content = $(roundId);  
            const icon = $('icon-' + roundId);  
            content.classList.toggle('expanded');  
            icon.classList.toggle('collapsed');  
        }

        function exportResults() {  
            if (roundHistory.length === 0) return alert('âŒ æš‚æ— ä¸­å¥–æ•°æ®');  
            let csv = '\uFEFFè½®æ¬¡,å¥–å“,èµåŠ©å®˜,å§“å,éƒ¨é—¨,æ—¶é—´\n';
            roundHistory.forEach(round => {  
                round.winners.forEach(person => {  
                    csv += `ç¬¬${round.round}è½®,${round.prize},${round.sponsor || 'æ— '},${person.name},${person.dept || ''},${round.time}\n`;  
                });
            });
            const blob = new Blob([csv], { type: 'text/csv' });  
            const url = URL.createObjectURL(blob);  
            const a = document.createElement('a');  
            a.href = url;  
            a.download = `ä¸­å¥–åå•_${Date.now()}.csv`;  
            a.click();  
        }

        function fireworks() {  
            const colors = [  
                getComputedStyle(document.body).getPropertyValue('--text-primary'),  
                getComputedStyle(document.body).getPropertyValue('--accent-color'),  
                '#ffffff'  
            ];
            
            for (let i = 0; i < 30; i++) {  
                setTimeout(() => {  
                    const x = Math.random() * window.innerWidth;  
                    const y = Math.random() * window.innerHeight * 0.7;  
                    for (let j = 0; j < 10; j++) {  
                        const particle = document.createElement('div');  
                        particle.className = 'firework';  
                        particle.style.left = x + 'px';  
                        particle.style.top = y + 'px';  
                        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];  
                        const angle = (j / 10) * Math.PI * 2;  
                        const distance = 80 + Math.random() * 80;  
                        particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');  
                        particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');  
                        document.body.appendChild(particle);  
                        setTimeout(() => particle.remove(), 1000);  
                    }
                }, i * 150);  
            }
        }

        function createCoins() {  
            const coins = ['ğŸ’°', 'ğŸ', 'â­', 'ğŸ’', 'ğŸ†'];  
            const interval = setInterval(() => {  
                if (!isRolling) { clearInterval(interval); return; }  
                const coin = document.createElement('div');  
                coin.className = 'coin';  
                coin.textContent = coins[Math.floor(Math.random() * coins.length)];  
                coin.style.left = Math.random() * window.innerWidth + 'px';  
                coin.style.animationDuration = (2 + Math.random() * 3) + 's';  
                document.body.appendChild(coin);  
                setTimeout(() => coin.remove(), 5000);  
            }, 150);
        }

        function celebrate() { fireworks(); }  
        
        // åˆå§‹åŒ–
        updatePoolDisplay();  
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è®¡ç®—å¸ƒå±€
        window.addEventListener('resize', () => {
            if (!$('result-area').classList.contains('hidden')) {
                const count = parseInt($('display-count').textContent) || 1;
                // é‡æ–°æ¸²æŸ“ä¸­å¥–ç»“æœä»¥é€‚åº”æ–°å°ºå¯¸
                if (roundHistory.length > 0) {
                    const lastRound = roundHistory[roundHistory.length - 1];
                    showWinners(lastRound.winners, lastRound.prize);
                }
            }
        });
    </script>  
</body>  
</html>
